<div class="editor-container" [class.with-validation-panel]="showValidationPanel">
  <div class="header">
    <h2>
      {{ projectName }}
      <span class="unsaved-indicator" *ngIf="saveState?.hasUnsavedChanges">‚óè</span>
    </h2>
    <div class="save-status" *ngIf="saveState">
      <span class="status-text" *ngIf="saveState.lastSaved">
        Last saved: {{ saveState.lastSaved | date:'short' }}
      </span>
      <span class="status-text" *ngIf="saveState.isAutoSaveEnabled">
        <mat-icon class="auto-save-icon">sync</mat-icon>
        Auto-save enabled
      </span>
    </div>
    <div class="header-actions">
      <button mat-icon-button (click)="openContractPreview()" 
              matTooltip="Preview Full Contract (Ctrl+P)">
        <mat-icon>preview</mat-icon>
      </button>
      <button mat-icon-button (click)="saveDocument()" 
              matTooltip="Save (Ctrl+S)"
              [disabled]="!saveState?.hasUnsavedChanges">
        <mat-icon>save</mat-icon>
      </button>
      <button mat-icon-button (click)="toggleValidationPanel()" 
              matTooltip="Toggle validation panel"
              [color]="validationResult && validationResult.totalIssues > 0 ? 'warn' : ''">
        <mat-icon [matBadge]="validationResult?.totalIssues || 0" 
                  [matBadgeHidden]="!validationResult || validationResult.totalIssues === 0"
                  matBadgeColor="warn"
                  matBadgeSize="small">
          rule
        </mat-icon>
      </button>
      <button mat-icon-button [matMenuTriggerFor]="fileMenu" matTooltip="File options">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #fileMenu="matMenu">
        <button mat-menu-item (click)="saveAs()">
          <mat-icon>save_as</mat-icon>
          Save As...
        </button>
        <button mat-menu-item (click)="toggleAutoSave()">
          <mat-icon>{{ saveState?.isAutoSaveEnabled ? 'sync_disabled' : 'sync' }}</mat-icon>
          {{ saveState?.isAutoSaveEnabled ? 'Disable' : 'Enable' }} Auto-save
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="exportEndpoints()">
          <mat-icon>table_chart</mat-icon>
          Export as CSV
        </button>
        <button mat-menu-item (click)="exportValidationReport()">
          <mat-icon>assessment</mat-icon>
          Export Validation Report
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Saved Filters Panel -->
  <div class="saved-filters-panel mat-elevation-z4" *ngIf="showSavedFilters">
    <div class="saved-filters-header">
      <h3>Saved Filters</h3>
      <button mat-icon-button (click)="toggleSavedFilters()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="saved-filters-content">
      <div class="saved-filter-item" *ngFor="let filter of savedFilters">
        <div class="filter-info" (click)="applySavedFilter(filter)">
          <div class="filter-name">{{ filter.name }}</div>
          <div class="filter-details">
            <span *ngIf="filter.searchTerm">Search: "{{ filter.searchTerm }}"</span>
            <span *ngIf="filter.filterMethod">Method: {{ filter.filterMethod }}</span>
            <span *ngIf="filter.filterTag">Tag: {{ filter.filterTag }}</span>
            <span *ngIf="filter.filterExtension">Extension: {{ filter.filterExtension }}</span>
          </div>
          <div class="filter-date">{{ filter.createdAt | date:'short' }}</div>
        </div>
        <button mat-icon-button (click)="deleteSavedFilter(filter)" class="delete-filter">
          <mat-icon>delete</mat-icon>
        </button>
      </div>
      <div class="no-saved-filters" *ngIf="savedFilters.length === 0">
        <mat-icon>bookmark_border</mat-icon>
        <p>No saved filters yet</p>
        <p>Apply filters and click "Save Filter" to save them for later use</p>
      </div>
    </div>
  </div>

  <div class="toolbar">
    <button mat-raised-button color="primary" (click)="createNewEndpoint()" class="new-endpoint-button">
      <mat-icon>add</mat-icon>
      New Endpoint
    </button>
    
    <div class="spacer"></div>
    
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search endpoints</mat-label>
      <input matInput 
             [ngModel]="searchTerm"
             (ngModelChange)="onSearchChange($event)"
             placeholder="Search by method, path, summary, tags...">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>
    
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Filter by Method</mat-label>
      <mat-select [(ngModel)]="filterMethod" (ngModelChange)="onMethodFilterChange($event)">
        <mat-option value="">All Methods</mat-option>
        <mat-option *ngFor="let method of availableMethods" [value]="method">
          {{ method }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Filter by Tag</mat-label>
      <mat-select [(ngModel)]="filterTag" (ngModelChange)="onTagFilterChange($event)">
        <mat-option value="">All Tags</mat-option>
        <mat-option *ngFor="let tag of availableTags" [value]="tag">
          {{ tag }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Filter by Extension</mat-label>
      <mat-select [(ngModel)]="filterExtension" (ngModelChange)="onExtensionFilterChange($event)">
        <mat-option value="">All Extensions</mat-option>
        <mat-option *ngFor="let ext of availableExtensions" [value]="ext">
          {{ ext }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    
    <button mat-button (click)="clearFilters()" *ngIf="searchTerm || filterMethod || filterTag || filterExtension">
      <mat-icon>clear</mat-icon>
      Clear Filters
    </button>
    
    <button mat-button (click)="saveCurrentFilter()" *ngIf="hasActiveFilters()" color="accent">
      <mat-icon>bookmark</mat-icon>
      Save Filter
    </button>
    
    <button mat-button (click)="toggleSavedFilters()" 
            [matBadge]="savedFilters.length" 
            [matBadgeHidden]="savedFilters.length === 0"
            matBadgeSize="small">
      <mat-icon>bookmarks</mat-icon>
      Saved Filters
    </button>
    
    <div class="spacer"></div>
    
    <div class="toolbar-actions">
      <button mat-raised-button color="primary" (click)="addEndpoint()">
        <mat-icon>add</mat-icon>
        Add Endpoint
      </button>
      
      <button mat-raised-button color="warn" 
              [disabled]="selectedEndpoints.size === 0"
              (click)="deleteSelected()">
        <mat-icon>delete</mat-icon>
        Delete Selected ({{ selectedEndpoints.size }})
      </button>
    </div>
  </div>

  <div class="table-container mat-elevation-z2">
    <div class="loading-overlay" *ngIf="isLoading">
      <mat-spinner></mat-spinner>
    </div>
    
    <table mat-table [dataSource]="dataSource" matSort class="endpoints-table">
      
      <!-- Selection Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox (change)="toggleAllSelection()"
                        [checked]="isAllSelected()"
                        [indeterminate]="selectedEndpoints.size > 0 && selectedEndpoints.size < endpoints.length">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let endpoint">
          <mat-checkbox (change)="toggleSelection(endpoint)"
                        [checked]="endpoint.selected">
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Method Column -->
      <ng-container matColumnDef="method">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Method </th>
        <td mat-cell *matCellDef="let endpoint">
          <span class="method-badge" [ngClass]="endpoint.method.toLowerCase()">
            {{ endpoint.method }}
          </span>
        </td>
      </ng-container>

      <!-- Path Column -->
      <ng-container matColumnDef="path">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Path </th>
        <td mat-cell *matCellDef="let endpoint">
          <span [class.deprecated]="endpoint.deprecated">
            {{ endpoint.path }}
          </span>
          <mat-icon *ngIf="endpoint.deprecated" class="deprecated-icon" 
                    matTooltip="This endpoint is deprecated">
            warning
          </mat-icon>
        </td>
      </ng-container>

      <!-- Summary Column -->
      <ng-container matColumnDef="summary">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Summary </th>
        <td mat-cell *matCellDef="let endpoint"> 
          {{ endpoint.summary || endpoint.description || '-' }} 
        </td>
      </ng-container>
      
      <!-- Tags Column -->
      <ng-container matColumnDef="tags">
        <th mat-header-cell *matHeaderCellDef> Tags </th>
        <td mat-cell *matCellDef="let endpoint">
          <mat-chip-set *ngIf="endpoint.tags && endpoint.tags.length > 0">
            <mat-chip *ngFor="let tag of endpoint.tags" class="tag-chip">
              {{ tag }}
            </mat-chip>
          </mat-chip-set>
          <span *ngIf="!endpoint.tags || endpoint.tags.length === 0">-</span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Actions </th>
        <td mat-cell *matCellDef="let endpoint">
          <button mat-icon-button (click)="previewEndpoint(endpoint)" matTooltip="Preview OpenAPI">
            <mat-icon>code</mat-icon>
          </button>
          <button mat-icon-button (click)="viewEndpoint(endpoint)" matTooltip="View Details">
            <mat-icon>visibility</mat-icon>
          </button>
          <button mat-icon-button (click)="editEndpoint(endpoint)" matTooltip="Edit">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button [matMenuTriggerFor]="moreMenu" matTooltip="More Actions">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #moreMenu="matMenu">
            <button mat-menu-item (click)="createSimilarEndpoint(endpoint)">
              <mat-icon>content_copy</mat-icon>
              <span>Create Similar</span>
            </button>
            <button mat-menu-item (click)="duplicateEndpoint(endpoint)">
              <mat-icon>file_copy</mat-icon>
              <span>Duplicate</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="deleteEndpoint(endpoint)" class="delete-action">
              <mat-icon color="warn">delete</mat-icon>
              <span>Delete</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"
          [class.selected-row]="selectedEndpoints.has(row.id)"></tr>
      
      <!-- Row shown when there is no data -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          <div class="no-data">
            <mat-icon>inbox</mat-icon>
            <p>No endpoints found</p>
            <button mat-button color="primary" (click)="addEndpoint()">
              Add your first endpoint
            </button>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" 
                 [pageSize]="25"
                 showFirstLastButtons
                 aria-label="Select page of endpoints">
  </mat-paginator>
  
  <!-- Validation Panel -->
  <div class="validation-panel" *ngIf="showValidationPanel" [style.width.px]="validationPanelWidth">
    <div class="validation-header">
      <h3>
        <mat-icon>rule</mat-icon>
        Validation Results
      </h3>
      <button mat-icon-button (click)="toggleValidationPanel()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    
    <div class="validation-summary" *ngIf="validationResult">
      <div class="summary-item" [style.color]="'#f44336'">
        <mat-icon>error</mat-icon>
        <span>{{ validationResult.errors.length }} Errors</span>
      </div>
      <div class="summary-item" [style.color]="'#ff9800'">
        <mat-icon>warning</mat-icon>
        <span>{{ validationResult.warnings.length }} Warnings</span>
      </div>
      <div class="summary-item" [style.color]="'#2196f3'">
        <mat-icon>info</mat-icon>
        <span>{{ validationResult.info.length }} Info</span>
      </div>
      <div class="summary-item" [style.color]="'#9c27b0'">
        <mat-icon>lightbulb</mat-icon>
        <span>{{ validationResult.hints.length }} Hints</span>
      </div>
    </div>
    
    <div class="validation-content">
      <div class="validation-section" *ngIf="validationResult && validationResult.errors && validationResult.errors.length > 0">
        <h4>Errors</h4>
        <div class="validation-item" *ngFor="let error of validationResult!.errors" 
             (click)="navigateToError(error)">
          <mat-icon [style.color]="'#f44336'">error</mat-icon>
          <div class="validation-details">
            <div class="validation-message">{{ error.message }}</div>
            <div class="validation-path">{{ error.path.join(' > ') }}</div>
            <div class="validation-source">Source: {{ error.source }}</div>
          </div>
        </div>
      </div>
      
      <div class="validation-section" *ngIf="validationResult && validationResult.warnings && validationResult.warnings.length > 0">
        <h4>Warnings</h4>
        <div class="validation-item" *ngFor="let warning of validationResult!.warnings"
             (click)="navigateToError(warning)">
          <mat-icon [style.color]="'#ff9800'">warning</mat-icon>
          <div class="validation-details">
            <div class="validation-message">{{ warning.message }}</div>
            <div class="validation-path">{{ warning.path.join(' > ') }}</div>
            <div class="validation-source">Source: {{ warning.source }}</div>
          </div>
        </div>
      </div>
      
      <div class="validation-section" *ngIf="validationResult && validationResult.info && validationResult.info.length > 0">
        <h4>Information</h4>
        <div class="validation-item" *ngFor="let info of validationResult!.info"
             (click)="navigateToError(info)">
          <mat-icon [style.color]="'#2196f3'">info</mat-icon>
          <div class="validation-details">
            <div class="validation-message">{{ info.message }}</div>
            <div class="validation-path">{{ info.path.join(' > ') }}</div>
            <div class="validation-source">Source: {{ info.source }}</div>
          </div>
        </div>
      </div>
      
      <div class="validation-section" *ngIf="validationResult && validationResult.hints && validationResult.hints.length > 0">
        <h4>Hints</h4>
        <div class="validation-item" *ngFor="let hint of validationResult!.hints"
             (click)="navigateToError(hint)">
          <mat-icon [style.color]="'#9c27b0'">lightbulb</mat-icon>
          <div class="validation-details">
            <div class="validation-message">{{ hint.message }}</div>
            <div class="validation-path">{{ hint.path.join(' > ') }}</div>
            <div class="validation-source">Source: {{ hint.source }}</div>
          </div>
        </div>
      </div>
      
      <div class="no-validation-issues" *ngIf="validationResult && validationResult.totalIssues === 0">
        <mat-icon>check_circle</mat-icon>
        <p>No validation issues found!</p>
        <p>Your OpenAPI document is valid.</p>
      </div>
    </div>
  </div>
</div>